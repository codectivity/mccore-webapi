<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - MCCore Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #000000;
            color: #ffffff;
        }
        .nav-glass {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }
        .card-glass {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .input-field {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: border-color 0.2s ease;
        }
        .input-field:focus {
            border-color: #ffffff;
            outline: none;
        }
    </style>
</head>
<body class="min-h-screen bg-black text-white">
    <!-- Navigation -->
    <nav class="nav-glass border-b border-gray-800 sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center space-x-8">
                    <div class="flex items-center space-x-2">
                        <svg width="32" height="32" viewBox="0 0 512 512" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <g clip-path="url(#clip0_1_27)">
                                <path d="M378.304 430.668C380.765 434.183 379.918 439.04 376.319 441.377C344.38 462.107 307.585 474.258 269.492 476.588C228.81 479.076 188.233 470.266 152.247 451.131C116.26 431.997 86.2659 403.284 65.58 368.166C44.8941 333.048 34.3224 292.894 35.0337 252.143C35.745 211.392 47.7116 171.631 69.6105 137.257C91.5094 102.882 122.488 75.2333 159.12 57.3665C195.752 39.4997 236.612 32.111 277.182 36.0174C315.17 39.6753 351.519 53.1033 382.715 74.9354C386.231 77.3959 386.908 82.2798 384.325 85.7069C381.743 89.134 376.879 89.8055 373.357 87.3544C344.455 67.2419 310.828 54.8689 275.693 51.4857C237.976 47.854 199.989 54.7231 165.932 71.3336C131.876 87.9441 103.076 113.649 82.7167 145.606C62.3576 177.564 51.2325 214.529 50.5712 252.414C49.9099 290.3 59.7382 327.631 78.9696 360.279C98.2009 392.927 126.086 419.622 159.542 437.411C192.998 455.2 230.722 463.39 268.543 461.077C303.775 458.922 337.813 447.73 367.399 428.639C371.005 426.312 375.842 427.153 378.304 430.668Z" fill="#D9D9D9"/>
                                <circle cx="361.838" cy="255.838" r="149.838" fill="#D9D9D9"/>
                            </g>
                            <defs>
                                <clipPath id="clip0_1_27">
                                    <rect width="512" height="512" fill="white"/>
                                </clipPath>
                            </defs>
                        </svg>
                        <span class="text-lg font-semibold">MCCore</span>
                    </div>
                    <div class="hidden md:flex items-center space-x-6">
                        <a href="/" class="text-gray-300 hover:text-white transition-colors">Dashboard</a>
                        <a href="/keys" class="text-gray-300 hover:text-white transition-colors">API Keys</a>
                        <a href="/assets" class="text-white">Launchers</a>
                        <a href="/java" class="text-gray-300 hover:text-white transition-colors">Java</a>
                        <a href="/news" class="text-gray-300 hover:text-white transition-colors">News</a>
                        <a href="/hwids" class="text-gray-300 hover:text-white transition-colors">HWIDs</a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/logout" class="text-gray-400 hover:text-white transition-colors">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-12">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold mb-2">Launcher Management</h1>
                <p class="text-gray-400">Manage launchers and their configurations</p>
            </div>
            <button 
                onclick="showCreateAssetModal()"
                class="px-6 py-3 bg-white text-black rounded-md hover:bg-gray-100 transition-colors"
            >
                Add Asset
            </button>
        </div>

        <!-- Create Asset Modal -->
        <div id="createAssetModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm overflow-y-auto h-full w-full z-50">
            <div class="relative top-10 mx-auto p-6 border w-full max-w-2xl shadow-2xl rounded-lg bg-gray-900 border-gray-700">
                <div class="mb-6">
                    <h3 class="text-xl font-bold mb-2">Add Launcher Asset</h3>
                    <p class="text-gray-400 text-sm">Create a new launcher asset for client distribution</p>
                </div>
                <form id="createAssetForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="clientId" class="block text-sm font-medium text-gray-300 mb-2">Client ID</label>
                            <input 
                                type="text" 
                                id="clientId" 
                                name="client_id"
                                placeholder="Enter client ID"
                                class="input-field w-full px-4 py-3 rounded-md text-white placeholder-gray-400"
                                required
                            >
                        </div>
                        <div data-create-standard>
                            <label for="version" class="block text-sm font-medium text-gray-300 mb-2">Default Version</label>
                            <div class="flex gap-2">
                                <input 
                                    type="text" 
                                    id="version" 
                                    name="version"
                                    placeholder="e.g., 1.20.1-forge"
                                    class="input-field flex-1 px-4 py-3 rounded-md text-white placeholder-gray-400"
                                >
                                <button type="button" data-create-standard onclick="addVersionEntry()" class="px-4 py-2 text-sm text-blue-400 hover:text-blue-300 transition-colors whitespace-nowrap" title="Add version"><i class="fas fa-plus"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-2">
                        <label class="block text-sm font-medium text-gray-300 mb-2">Mode</label>
                        <div class="flex items-center gap-4">
                            <label class="inline-flex items-center gap-2">
                                <input type="radio" name="source" value="standard" checked onchange="toggleCreateMode()">
                                <span>Standard</span>
                            </label>
                            <label class="inline-flex items-center gap-2">
                                <input type="radio" name="source" value="custom" onchange="toggleCreateMode()">
                                <span>Custom JSON</span>
                            </label>
                        </div>
                    </div>
                    <div id="versionsContainer" data-create-standard class="space-y-2 mt-2"></div>
                    <div>
                        <label for="server" class="block text-sm font-medium text-gray-300 mb-2">Server</label>
                        <input 
                            type="text" 
                            id="server" 
                            name="server"
                            placeholder="Enter server name"
                            class="input-field w-full px-4 py-3 rounded-md text-white placeholder-gray-400"
                            required
                        >
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6" data-create-standard>
                        <div>
                            <label for="default_base_url" class="block text-sm font-medium text-gray-300 mb-2">Default Base URL</label>
                            <input 
                                type="url" 
                                id="default_base_url" 
                                name="default_base_url"
                                placeholder="Enter base URL for default version"
                                class="input-field w-full px-4 py-3 rounded-md text-white placeholder-gray-400"
                                required
                            >
                        </div>
                        <div>
                            <label for="default_mods_manifest_url" class="block text-sm font-medium text-gray-300 mb-2">Default Mods Manifest URL</label>
                            <input 
                                type="text" 
                                id="default_mods_manifest_url" 
                                name="default_mods_manifest_url"
                                placeholder="Enter mods manifest URL for default version"
                                class="input-field w-full px-4 py-3 rounded-md text-white placeholder-gray-400"
                                required
                            >
                        </div>
                        <div>
                            <label for="default_rp_manifest_url" class="block text-sm font-medium text-gray-300 mb-2">Default Resource Pack Manifest URL</label>
                            <input 
                                type="text" 
                                id="default_rp_manifest_url" 
                                name="default_rp_manifest_url"
                                placeholder="Enter RP manifest URL for default version"
                                class="input-field w-full px-4 py-3 rounded-md text-white placeholder-gray-400"
                                required
                            >
                        </div>
                    </div>
                    <div data-create-custom class="hidden">
                        <label for="create_custom_json" class="block text-sm font-medium text-gray-300 mb-2">Custom JSON</label>
                        <textarea id="create_custom_json" name="custom_json" rows="20" class="input-field w-full px-4 py-3 rounded-md text-white font-mono text-sm" placeholder='{
  "id": "1.20.1-custom",
  "type": "release",
  "inheritsFrom": "1.20.1",
  "time": "2025-01-01T00:00:00Z",
  "releaseTime": "2025-01-01T00:00:00Z",
  "mainClass": "net.minecraft.client.main.Main",
  "arguments": { "game": [] },
  "downloads": {},
  "libraries": []
}'></textarea>
                        <p class="text-xs text-gray-500 mt-2">When enabled, base and additional version options are ignored; this JSON will be served for the client.</p>
                    </div>
                    <div>
                        <label for="privateKey" class="block text-sm font-medium text-gray-300 mb-2">Private Key</label>
                        <textarea 
                            id="privateKey" 
                            name="private_key"
                            rows="8"
                            placeholder="Enter RSA private key"
                            class="input-field w-full px-4 py-3 rounded-md text-white placeholder-gray-400 font-mono text-sm"
                            required
                        ></textarea>
                        <p class="text-xs text-gray-500 mt-2">Enter the RSA private key for signing</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Social Media Links</label>
                        <div id="socialMediaContainer" class="space-y-3">
                            <div class="social-media-entry flex gap-3">
                                <input 
                                    type="text" 
                                    name="social_media_platform[]"
                                    placeholder="Platform (e.g., discord, instagram)"
                                    class="input-field flex-1 px-4 py-3 rounded-md text-white placeholder-gray-400"
                                >
                                <input 
                                    type="url" 
                                    name="social_media_url[]"
                                    placeholder="URL"
                                    class="input-field flex-1 px-4 py-3 rounded-md text-white placeholder-gray-400"
                                >
                                <button 
                                    type="button"
                                    onclick="removeSocialMediaEntry(this)"
                                    class="px-3 py-3 text-red-400 hover:text-red-300 transition-colors"
                                    title="Remove"
                                >
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <button 
                            type="button"
                            onclick="addSocialMediaEntry()"
                            class="mt-2 px-4 py-2 text-sm text-blue-400 hover:text-blue-300 transition-colors"
                        >
                            <i class="fas fa-plus"></i> Add Social Media Link
                        </button>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button 
                            type="button"
                            onclick="hideCreateAssetModal()"
                            class="px-6 py-3 text-gray-300 border border-gray-600 rounded-md hover:bg-gray-800 transition-colors"
                        >
                            Cancel
                        </button>
                        <button 
                            type="submit"
                            class="px-6 py-3 bg-white text-black rounded-md hover:bg-gray-100 transition-colors"
                        >
                            Add Asset
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Assets List -->
        <div class="card-glass rounded-lg overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-700">
                <h2 class="text-lg font-semibold">Launcher Assets</h2>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-black/20">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Client ID</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Versions</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Server</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Social Media</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Created</th>
                            <th class="px-6 py-4 text-left text-xs font-medium text-gray-400 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700" id="assetsTable">
                        <!-- Assets will be loaded here via JavaScript -->
                    </tbody>
                </table>
            </div>
            <div id="noAssetsMessage" class="px-6 py-12 text-center text-gray-400 hidden">
                <i class="fas fa-download text-3xl mb-4 opacity-50"></i>
                <p class="text-lg font-medium mb-2">No launcher assets found</p>
                <p class="text-sm">Add your first asset to get started</p>
            </div>
        </div>
    </main>

    <!-- Edit Asset Modal -->
    <div id="editAssetModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm overflow-y-auto h-full w-full z-50">
        <div class="relative top-10 mx-auto p-6 border w-full max-w-2xl shadow-2xl rounded-lg bg-gray-900 border-gray-700">
            <div class="mb-6">
                <h3 class="text-xl font-bold mb-2">Edit Launcher Asset</h3>
                <p class="text-gray-400 text-sm">Update fields for the selected client</p>
            </div>
            <form id="editAssetForm" class="space-y-6">
                <input type="hidden" id="edit_client_id" name="client_id">
                <div id="editFormGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Client ID</label>
                        <input type="text" id="edit_client_id_display" class="input-field w-full px-4 py-3 rounded-md text-white" disabled>
                    </div>
                    <div data-edit-standard>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Version</label>
                        <div class="flex gap-2">
                            <input type="text" id="edit_version" name="version" class="input-field flex-1 px-4 py-3 rounded-md text-white">
                            <button type="button" onclick="addEditVersionEntry()" class="px-4 py-2 text-sm text-blue-400 hover:text-blue-300 transition-colors whitespace-nowrap" title="Add version"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-2">
                    <div data-edit-standard>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Default Base URL</label>
                        <input type="url" id="edit_default_base_url" class="input-field w-full px-4 py-3 rounded-md text-white" required>
                    </div>
                    <div data-edit-standard>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Default Mods Manifest URL</label>
                        <input type="text" id="edit_default_mods_manifest_url" class="input-field w-full px-4 py-3 rounded-md text-white" required>
                    </div>
                    <div data-edit-standard>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Default RP Manifest URL</label>
                        <input type="text" id="edit_default_rp_manifest_url" class="input-field w-full px-4 py-3 rounded-md text-white" required>
                    </div>
                </div>
                    <div data-edit-standard>
                        <label class="block text-sm font-medium text-gray-300 mb-2 mt-2">Additional Versions and Manifests</label>
                        <div id="edit_versions_container" class="space-y-2"></div>
                        <button type="button" onclick="addEditVersionEntry()" class="mt-2 px-4 py-2 text-sm text-blue-400 hover:text-blue-300 transition-colors">
                            <i class="fas fa-plus"></i> Add Version
                        </button>
                    </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Server</label>
                    <input type="text" id="edit_server" name="server" class="input-field w-full px-4 py-3 rounded-md text-white" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Private Key</label>
                    <textarea id="edit_private_key" name="private_key" rows="8" class="input-field w-full px-4 py-3 rounded-md text-white font-mono text-sm" placeholder="Leave unchanged to keep current key"></textarea>
                    <p class="text-xs text-gray-500 mt-2">If left empty, the existing key will be preserved</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Social Media Links (JSON)</label>
                    <textarea id="edit_social_media" name="social_media" rows="4" class="input-field w-full px-4 py-3 rounded-md text-white font-mono text-sm" placeholder='{"discord":"https://..."}'></textarea>
                </div>

                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="hideEditAssetModal()" class="px-6 py-3 text-gray-300 border border-gray-600 rounded-md hover:bg-gray-800 transition-colors">Cancel</button>
                    <button type="submit" class="px-6 py-3 bg-white text-black rounded-md hover:bg-gray-100 transition-colors">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:<%= process.env.PORT || 3000 %>/v2';
        const API_KEY = '<%= apiKey %>';
        function showCreateAssetModal() {
            document.getElementById('createAssetModal').classList.remove('hidden');
        }

        function hideCreateAssetModal() {
            document.getElementById('createAssetModal').classList.add('hidden');
        }

        async function loadAssets() {
            try {
                const response = await fetch(`${API_BASE}/admin/assets`, {
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayAssets(data.assets || []);
                } else {
                    console.error('Failed to load assets');
                    document.getElementById('noAssetsMessage').classList.remove('hidden');
                }
            } catch (error) {
                console.error('Error loading assets:', error);
                document.getElementById('noAssetsMessage').classList.remove('hidden');
            }
        }

        function displayAssets(assets) {
            const tbody = document.getElementById('assetsTable');
            const noAssetsMessage = document.getElementById('noAssetsMessage');

            if (assets.length === 0) {
                tbody.innerHTML = '';
                noAssetsMessage.classList.remove('hidden');
                return;
            }

            noAssetsMessage.classList.add('hidden');
            tbody.innerHTML = assets.map(asset => {
                const versions = Array.isArray(asset.version) ? asset.version : (asset.version ? [asset.version] : []);
                const versionDisplay = versions.join(', ');
                return `
                <tr class="hover:bg-black/20 transition-colors">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center space-x-3">
                            <div class="w-2 h-2 bg-blue-400 rounded-full"></div>
                            <span class="text-sm font-medium">${asset.client_id}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">
                        ${asset.source === 'custom' ? '<span class="text-yellow-400">custom</span>' : (versionDisplay ? 'v' + versionDisplay : '')}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">
                        ${asset.server}
                    </td>
                    
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">
                        ${getSocialMediaDisplay(asset.social_media)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">
                        ${new Date(asset.created_at).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400 space-x-3">
                        <button 
                            onclick="openEditAsset('${asset.client_id}')"
                            class="text-blue-400 hover:text-blue-300 transition-colors"
                            title="Edit asset"
                        >
                            <i class="fas fa-edit"></i>
                        </button>
                        <button 
                            onclick="deleteAsset('${asset.client_id}')"
                            class="text-red-400 hover:text-red-300 transition-colors"
                            title="Delete asset"
                        >
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
        }

        function addSocialMediaEntry() {
            const container = document.getElementById('socialMediaContainer');
            const newEntry = document.createElement('div');
            newEntry.className = 'social-media-entry flex gap-3';
            newEntry.innerHTML = `
                <input 
                    type="text" 
                    name="social_media_platform[]"
                    placeholder="Platform (e.g., discord, instagram)"
                    class="input-field flex-1 px-4 py-3 rounded-md text-white placeholder-gray-400"
                >
                <input 
                    type="url" 
                    name="social_media_url[]"
                    placeholder="URL"
                    class="input-field flex-1 px-4 py-3 rounded-md text-white placeholder-gray-400"
                >
                <button 
                    type="button"
                    onclick="removeSocialMediaEntry(this)"
                    class="px-3 py-3 text-red-400 hover:text-red-300 transition-colors"
                    title="Remove"
                >
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(newEntry);
        }

        function removeSocialMediaEntry(button) {
            button.closest('.social-media-entry').remove();
        }

        // Merge default and extra versions into a unique array
        function collectMergedVersions(defaultVersion, extraVersions) {
            const merged = [];
            const push = (v) => { if (typeof v === 'string') { const t = v.trim(); if (t) merged.push(t); } };
            push(defaultVersion);
            (extraVersions || []).forEach(push);
            return Array.from(new Set(merged));
        }

        function showEditAssetModal() {
            document.getElementById('editAssetModal').classList.remove('hidden');
        }
        function hideEditAssetModal() {
            document.getElementById('editAssetModal').classList.add('hidden');
        }

        async function openEditAsset(clientId) {
            try {
                const response = await fetch(`${API_BASE}/admin/assets/${encodeURIComponent(clientId)}`, {
                    headers: { 'Authorization': `Bearer ${API_KEY}` }
                });
                if (!response.ok) {
                    alert('Failed to load asset');
                    return;
                }
                const data = await response.json();
                const a = data.asset;
                // insert mode toggle if not present
                if (!document.querySelector('input[name="edit_source"]')) {
                    const container = document.getElementById('editFormGrid');
                    if (container) {
                        const col = document.createElement('div');
                        col.innerHTML = `
                            <label class="block text-sm font-medium text-gray-300 mb-2">Mode</label>
                            <div class="flex items-center gap-4">
                                <label class="inline-flex items-center gap-2">
                                    <input type="radio" name="edit_source" value="standard" onchange="toggleEditMode()">
                                    <span>Standard</span>
                                </label>
                                <label class="inline-flex items-center gap-2">
                                    <input type="radio" name="edit_source" value="custom" onchange="toggleEditMode()">
                                    <span>Custom JSON</span>
                                </label>
                            </div>
                        `;
                        container.appendChild(col);
                    }
                }
                const isCustom = a.source === 'custom';
                const radios = document.querySelectorAll('input[name="edit_source"]');
                radios.forEach(function(r) { if (r instanceof HTMLInputElement) { r.checked = (r.value === (isCustom ? 'custom' : 'standard')); } });
                document.getElementById('edit_client_id').value = a.client_id;
                document.getElementById('edit_client_id_display').value = a.client_id;
                // a.version is now an array; first element is default
                document.getElementById('edit_version').value = (Array.isArray(a.version) && a.version.length ? a.version[0] : (a.version || ''));
                document.getElementById('edit_server').value = a.server || '';
                // derive defaults from version_configs if present
                let vc = {};
                try { vc = a.version_configs || {}; } catch {}
                const defaultVersion = (Array.isArray(a.version) && a.version.length ? a.version[0] : (a.version || ''));
                const defaultCfg = vc[defaultVersion] || {};
                document.getElementById('edit_default_base_url').value = defaultCfg.base_url || a.base_url || '';
                document.getElementById('edit_default_mods_manifest_url').value = defaultCfg.mods_manifest_url || a.mods_manifest_url || '';
                document.getElementById('edit_default_rp_manifest_url').value = defaultCfg.rp_manifest_url || a.rp_manifest_url || '';
                document.getElementById('edit_private_key').value = '';
                try {
                    const sm = a.social_media ? JSON.parse(a.social_media) : {};
                    document.getElementById('edit_social_media').value = JSON.stringify(sm, null, 2);
                } catch {
                    document.getElementById('edit_social_media').value = a.social_media || '{}';
                }
                // Inject/edit dynamic version entries for remaining versions
                let editVersionsContainer = document.getElementById('edit_versions_container');
                if (!editVersionsContainer) {
                    const form = document.getElementById('editAssetForm');
                    const wrapper = document.createElement('div');
                    wrapper.innerHTML = `
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Additional Versions</label>
                            <div id="edit_versions_container" class="space-y-2"></div>
                            <button type="button" onclick="addEditVersionEntry()" class="mt-2 px-4 py-2 text-sm text-blue-400 hover:text-blue-300 transition-colors">
                                <i class="fas fa-plus"></i> Add Version
                            </button>
                        </div>
                    `;
                    form.insertBefore(wrapper, form.querySelector('.flex.justify-end'));
                    editVersionsContainer = document.getElementById('edit_versions_container');
                }
                editVersionsContainer.innerHTML = '';
                const remaining = (Array.isArray(a.version) ? a.version.slice(1) : []);
                remaining.forEach(v => {
                    const el = document.createElement('div');
                    el.className = 'grid grid-cols-1 md:grid-cols-4 gap-3 version-entry';
                    const cfg = (vc && vc[v]) || {};
                    el.innerHTML = `
                        <input type="text" name="edit_version[]" value="${v}" class="input-field px-4 py-3 rounded-md text-white placeholder-gray-400">
                        <input type="url" name="edit_base_url[]" value="${cfg.base_url || ''}" placeholder="Base URL" class="input-field px-4 py-3 rounded-md text-white placeholder-gray-400">
                        <input type="text" name="edit_mods_manifest_url[]" value="${cfg.mods_manifest_url || ''}" placeholder="Mods manifest URL" class="input-field px-4 py-3 rounded-md text-white placeholder-gray-400">
                        <div class="flex gap-2">
                          <input type="text" name="edit_rp_manifest_url[]" value="${cfg.rp_manifest_url || ''}" placeholder="RP manifest URL" class="input-field flex-1 px-4 py-3 rounded-md text-white placeholder-gray-400">
                          <button type="button" onclick="removeVersionEntry(this)" class="px-3 py-3 text-red-400 hover:text-red-300 transition-colors" title="Remove"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    editVersionsContainer.appendChild(el);
                });
                // ensure custom json textarea exists
                if (!document.getElementById('edit_custom_json')) {
                    const form = document.getElementById('editAssetForm');
                    const wrapper = document.createElement('div');
                    wrapper.innerHTML = `
                        <div data-edit-custom class="hidden">
                            <label class="block text-sm font-medium text-gray-300 mb-2">Custom JSON</label>
                            <textarea id="edit_custom_json" name="custom_json" rows="20" class="input-field w-full px-4 py-3 rounded-md text-white font-mono text-sm" placeholder='{
  "id": "1.20.1-custom",
  "type": "release",
  "inheritsFrom": "1.20.1",
  "time": "2025-01-01T00:00:00Z",
  "releaseTime": "2025-01-01T00:00:00Z",
  "mainClass": "net.minecraft.client.main.Main",
  "arguments": { "game": [] },
  "downloads": {},
  "libraries": []
}'></textarea>
                        </div>
                    `;
                    form.insertBefore(wrapper, form.querySelector('.flex.justify-end'));
                }
                try {
                    var cjEl = document.getElementById('edit_custom_json');
                    if (cjEl && cjEl instanceof HTMLTextAreaElement) {
                        cjEl.value = a.custom_json ? (typeof a.custom_json === 'string' ? a.custom_json : JSON.stringify(a.custom_json, null, 2)) : '';
                    }
                } catch {}
                toggleEditMode();
                showEditAssetModal();
            } catch (e) {
                console.error('Error loading asset', e);
                alert('Failed to load asset');
            }
        }

        document.getElementById('editAssetForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const clientId = (document.getElementById('edit_client_id').value || '').trim();
            const updates = {
                version: collectMergedVersions(
                    (document.getElementById('edit_version').value || '').trim(),
                    Array.from(document.querySelectorAll('input[name="edit_version[]"]')).map((i) => i.value)
                ),
                server: (document.getElementById('edit_server').value || '').trim(),
            };
            const editSourceInput = document.querySelector('input[name="edit_source"]:checked');
            const editSource = (editSourceInput && editSourceInput instanceof HTMLInputElement) ? editSourceInput.value : 'standard';
            updates.source = editSource;
            if (editSource === 'custom') {
                var cjVal = '';
                var cjEl2 = document.getElementById('edit_custom_json');
                if (cjEl2 && cjEl2 instanceof HTMLTextAreaElement) cjVal = (cjEl2.value || '').trim();
                const cj = cjVal;
                if (!cj) { alert('Custom JSON is required in custom mode'); return; }
                updates.custom_json = cj;
                // In custom mode, ignore version fields
                delete updates.version_configs;
                delete updates.base_url;
                delete updates.mods_manifest_url;
                delete updates.rp_manifest_url;
            }
            // Build version_configs
            const defaultVersion = (document.getElementById('edit_version').value || '').trim();
            const vc = {};
            const defBase = (document.getElementById('edit_default_base_url').value || '').trim();
            const defMods = (document.getElementById('edit_default_mods_manifest_url').value || '').trim();
            const defRp = (document.getElementById('edit_default_rp_manifest_url').value || '').trim();
            if (editSource !== 'custom' && defaultVersion && defBase && defMods && defRp) {
                vc[defaultVersion] = { base_url: defBase, mods_manifest_url: defMods, rp_manifest_url: defRp };
            }
            if (editSource !== 'custom') {
                const versionInputs = Array.from(document.querySelectorAll('input[name="edit_version[]"]'));
                const baseInputs = Array.from(document.querySelectorAll('input[name="edit_base_url[]"]'));
                const modsInputs = Array.from(document.querySelectorAll('input[name="edit_mods_manifest_url[]"]'));
                const rpInputs = Array.from(document.querySelectorAll('input[name="edit_rp_manifest_url[]"]'));
                for (let i = 0; i < versionInputs.length; i++) {
                    const v = (((versionInputs[i] || {})['value']) || '').trim();
                    const b = (((baseInputs[i] || {})['value']) || '').trim();
                    const m = (((modsInputs[i] || {})['value']) || '').trim();
                    const r = (((rpInputs[i] || {})['value']) || '').trim();
                    if (v && b && m && r) {
                        vc[v] = { base_url: b, mods_manifest_url: m, rp_manifest_url: r };
                    }
                }
            }
            if (editSource !== 'custom' && Object.keys(vc).length > 0) {
                updates.version_configs = vc;
                // Also set top-level fallbacks from default
                updates.base_url = defBase;
                updates.mods_manifest_url = defMods;
                updates.rp_manifest_url = defRp;
            }
            const pk = (document.getElementById('edit_private_key').value || '').trim();
            if (pk) updates['private_key'] = pk;
            const smText = (document.getElementById('edit_social_media').value || '').trim();
            if (smText) {
                try {
                    const sm = JSON.parse(smText);
                    updates['social_media'] = JSON.stringify(sm);
                } catch (e) {
                    alert('Social media must be valid JSON');
                    return;
                }
            }
            const verText = (document.getElementById('edit_versions')?.value || '').trim();
            if (verText) {
                try {
                    const vv = JSON.parse(verText);
                    if (Array.isArray(vv)) updates['versions'] = vv;
                } catch (e) {
                    alert('Versions must be valid JSON array');
                    return;
                }
            }

            try {
                const response = await fetch(`${API_BASE}/admin/assets/${encodeURIComponent(clientId)}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updates)
                });
                if (!response.ok) {
                    const err = await response.json().catch(() => ({ message: 'Unknown error' }));
                    alert('Failed to update asset: ' + err.message);
                    return;
                }
                hideEditAssetModal();
                await loadAssets();
            } catch (error) {
                console.error('Error updating asset', error);
                alert('Failed to update asset');
            }
        });

        function getSocialMediaDisplay(socialMediaJson) {
            if (!socialMediaJson) return 'None';
            
            try {
                const socialMedia = JSON.parse(socialMediaJson);
                const platforms = Object.keys(socialMedia);
                
                if (platforms.length === 0) return 'None';
                
                return platforms.map(platform => 
                    `<span class="inline-block bg-blue-500 text-white text-xs px-2 py-1 rounded mr-1 mb-1">${platform}</span>`
                ).join('');
            } catch (error) {
                return 'Invalid';
            }
        }

        function addVersionEntry() {
            const container = document.getElementById('versionsContainer');
            const row = document.createElement('div');
            row.className = 'grid grid-cols-1 md:grid-cols-4 gap-3 version-entry';
            row.innerHTML = `
                <input type="text" name="version[]" placeholder="Version (e.g., 1.20.1-forge)" class="input-field px-4 py-3 rounded-md text-white placeholder-gray-400">
                <input type="url" name="base_url[]" placeholder="Base URL" class="input-field px-4 py-3 rounded-md text-white placeholder-gray-400">
                <input type="text" name="mods_manifest_url[]" placeholder="Mods manifest URL" class="input-field px-4 py-3 rounded-md text-white placeholder-gray-400">
                <div class="flex gap-2">
                  <input type="text" name="rp_manifest_url[]" placeholder="RP manifest URL" class="input-field flex-1 px-4 py-3 rounded-md text-white placeholder-gray-400">
                  <button type="button" onclick="this.closest('.version-entry').remove()" class="px-3 py-3 text-red-400 hover:text-red-300 transition-colors" title="Remove"><i class="fas fa-trash"></i></button>
                </div>
            `;
            container.appendChild(row);
        }

        function addEditVersionEntry() {
            const container = document.getElementById('edit_versions_container');
            const row = document.createElement('div');
            row.className = 'grid grid-cols-1 md:grid-cols-4 gap-3 version-entry';
            row.innerHTML = `
                <input type="text" name="edit_version[]" placeholder="Version" class="input-field px-4 py-3 rounded-md text-white placeholder-gray-400">
                <input type="url" name="edit_base_url[]" placeholder="Base URL" class="input-field px-4 py-3 rounded-md text-white placeholder-gray-400">
                <input type="text" name="edit_mods_manifest_url[]" placeholder="Mods manifest URL" class="input-field px-4 py-3 rounded-md text-white placeholder-gray-400">
                <div class="flex gap-2">
                  <input type="text" name="edit_rp_manifest_url[]" placeholder="RP manifest URL" class="input-field flex-1 px-4 py-3 rounded-md text-white placeholder-gray-400">
                  <button type="button" onclick="this.closest('.version-entry').remove()" class="px-3 py-3 text-red-400 hover:text-red-300 transition-colors" title="Remove"><i class="fas fa-trash"></i></button>
                </div>
            `;
            container.appendChild(row);
        }

        async function createAsset(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const source = (formData.get('source') || 'standard').toString();
            
            // Build social media object from form data
            const socialMedia = {};
            const platforms = formData.getAll('social_media_platform[]');
            const urls = formData.getAll('social_media_url[]');
            
            for (let i = 0; i < platforms.length; i++) {
                const platform = platforms[i].trim();
                const url = urls[i].trim();
                if (platform && url) {
                    socialMedia[platform] = url;
                }
            }
            
            try {
                // Build version_configs
                const defaultVersion = (formData.get('version') || '').toString();
                const vc = {};
                const defBase = (document.getElementById('default_base_url').value || '').trim();
                const defMods = (document.getElementById('default_mods_manifest_url').value || '').trim();
                const defRp = (document.getElementById('default_rp_manifest_url').value || '').trim();
                if (source === 'standard') {
                    if (defaultVersion && defBase && defMods && defRp) {
                        vc[defaultVersion] = { base_url: defBase, mods_manifest_url: defMods, rp_manifest_url: defRp };
                    }
                    const extraVersions = Array.from(formData.getAll('version[]')).map(v => (v || '').toString());
                    const extraBases = Array.from(formData.getAll('base_url[]')).map(v => (v || '').toString());
                    const extraMods = Array.from(formData.getAll('mods_manifest_url[]')).map(v => (v || '').toString());
                    const extraRps = Array.from(formData.getAll('rp_manifest_url[]')).map(v => (v || '').toString());
                    for (let i = 0; i < extraVersions.length; i++) {
                        const v = (extraVersions[i] || '').trim();
                        const b = (extraBases[i] || '').trim();
                        const m = (extraMods[i] || '').trim();
                        const r = (extraRps[i] || '').trim();
                        if (v && b && m && r) {
                            vc[v] = { base_url: b, mods_manifest_url: m, rp_manifest_url: r };
                        }
                    }
                }

                const response = await fetch(`${API_BASE}/admin/assets`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({
                        client_id: formData.get('client_id'),
                        version: source === 'standard' ? collectMergedVersions(
                            (formData.get('version') || '').toString(),
                            Array.from(formData.getAll('version[]')).map(v => (v || '').toString())
                        ) : (formData.get('version') || '').toString(),
                        server: formData.get('server'),
                        base_url: source === 'standard' ? defBase : undefined,
                        mods_manifest_url: source === 'standard' ? defMods : undefined,
                        rp_manifest_url: source === 'standard' ? defRp : undefined,
                        version_configs: source === 'standard' && Object.keys(vc).length > 0 ? vc : undefined,
                        private_key: formData.get('private_key'),
                        social_media: Object.keys(socialMedia).length > 0 ? socialMedia : null,
                        source,
                        custom_json: source === 'custom' ? (document.getElementById('create_custom_json').value || '').trim() : undefined
                    })
                });

                if (response.ok) {
                    hideCreateAssetModal();
                    event.target.reset();
                    // Clear social media entries
                    document.getElementById('socialMediaContainer').innerHTML = `
                        <div class="social-media-entry flex gap-3">
                            <input 
                                type="text" 
                                name="social_media_platform[]"
                                placeholder="Platform (e.g., discord, instagram)"
                                class="input-field flex-1 px-4 py-3 rounded-md text-white placeholder-gray-400"
                            >
                            <input 
                                type="url" 
                                name="social_media_url[]"
                                placeholder="URL"
                                class="input-field flex-1 px-4 py-3 rounded-md text-white placeholder-gray-400"
                            >
                            <button 
                                type="button"
                                onclick="removeSocialMediaEntry(this)"
                                class="px-3 py-3 text-red-400 hover:text-red-300 transition-colors"
                                title="Remove"
                            >
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    loadAssets();
                    alert('Asset created successfully!');
                } else {
                    const error = await response.json();
                    alert('Failed to create asset: ' + error.message);
                }
            } catch (error) {
                console.error('Error creating asset:', error);
                alert('Failed to create asset');
            }
        }

        async function deleteAsset(clientId) {
            if (!confirm(`Are you sure you want to delete the asset for client ${clientId}? This action cannot be undone.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/admin/assets/${clientId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`
                    }
                });

                if (response.ok) {
                    loadAssets();
                } else {
                    const error = await response.json();
                    alert('Failed to delete asset: ' + error.message);
                }
            } catch (error) {
                console.error('Error deleting asset:', error);
                alert('Failed to delete asset');
            }
        }

        // Load assets on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAssets();
            document.getElementById('createAssetForm').addEventListener('submit', createAsset);
        });
        function toggleCreateMode() {
            var selected = document.querySelector('input[name="source"]:checked');
            var mode = (selected && selected instanceof HTMLInputElement) ? selected.value : 'standard';
            var stdEls = document.querySelectorAll('[data-create-standard]');
            var custEl = document.querySelector('[data-create-custom]');
            stdEls.forEach(function(el){ el.classList.toggle('hidden', mode === 'custom'); });
            if (custEl) custEl.classList.toggle('hidden', mode !== 'custom');
            var versionInput = document.getElementById('version');
            if (versionInput && versionInput instanceof HTMLInputElement) {
                versionInput.required = (mode !== 'custom');
                versionInput.disabled = (mode === 'custom');
            }
        }
        function toggleEditMode() {
            var selected = document.querySelector('input[name="edit_source"]:checked');
            var mode = (selected && selected instanceof HTMLInputElement) ? selected.value : 'standard';
            var stdLabels = document.querySelectorAll('#editAssetForm [data-edit-standard]');
            stdLabels.forEach(function(el){ el.classList.toggle('hidden', mode === 'custom'); });
            var custEl = document.querySelector('[data-edit-custom]');
            if (custEl) custEl.classList.toggle('hidden', mode !== 'custom');
            var editVersion = document.getElementById('edit_version');
            if (editVersion && editVersion instanceof HTMLInputElement) {
                editVersion.required = (mode !== 'custom');
                editVersion.disabled = (mode === 'custom');
            }
        }
    </script>
</body>
</html> 